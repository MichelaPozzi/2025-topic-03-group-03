---
title: "Exploration"
output: html_document
date: "2025-05-31"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
MS_Table_norm = read.table("DatensÃ¤tze/MS_Table.norm.csv", header=TRUE, row.names=1, sep = ",")
```

```{r}
install.packages("pracma")
```
#Goal: Now we have the normalized values for all proteins and can examine our dataset in detail. Our goal is to identify differences between the control and RNase samples. To do this, we first determine both absolute and local maxima for all proteins. To take it a step further, we want to create our own function that can assign each protein to a shift category based on criteria we define ourselves. So now, letâ€™s take a closer look at our proteins.

# Data exploration

#Vector of fraction names to later insert the names into our mean value tables.
```{r}
Fraktionsnamen = c('Fraction1_Ctrl', 'Fraction1_RNAse', 'Fraction2_Ctrl', 'Fraction2_RNAse','Fraction3_Ctrl', 'Fraction3_RNAse','Fraction4_Ctrl', 'Fraction4_RNAse','Fraction5_Ctrl', 'Fraction5_RNAse','Fraction6_Ctrl', 'Fraction6_RNAse','Fraction7_Ctrl', 'Fraction7_RNAse','Fraction8_Ctrl', 'Fraction8_RNAse','Fraction9_Ctrl', 'Fraction9_RNAse','Fraction10_Ctrl', 'Fraction10_RNAse','Fraction11_Ctrl', 'Fraction11_RNAse','Fraction12_Ctrl', 'Fraction12_RNAse','Fraction13_Ctrl', 'Fraction13_RNAse','Fraction14_Ctrl', 'Fraction14_RNAse','Fraction15_Ctrl', 'Fraction15_RNAse','Fraction16_Ctrl', 'Fraction16_RNAse','Fraction17_Ctrl', 'Fraction17_RNAse','Fraction18_Ctrl', 'Fraction18_RNAse','Fraction19_Ctrl', 'Fraction19_RNAse','Fraction20_Ctrl', 'Fraction20_RNAse','Fraction21_Ctrl', 'Fraction21_RNAse','Fraction22_Ctrl', 'Fraction22_RNAse','Fraction23_Ctrl', 'Fraction23_RNAse','Fraction24_Ctrl', 'Fraction24_RNAse','Fraction25_Ctrl', 'Fraction25_RNAse')
```

#create a vector of all protein names
```{r}
Proteinnamen = rownames(MS_Table)
```

#create subtables for each replicate from the normalized table
```{r}
for (i in 1:6) {

  spalten_index = seq(from = i, to = 150, by = 6) 
  teilmatrix = MS_Table_norm[, spalten_index]
  
  assign(Treatmentnamen[i], teilmatrix) # New subtables named correctly
}
```

#create two mean value tables for each replicate, one for control and one for RNAse
```{r}
# Mean values from the replicates
Mittelwert_matrix = t(apply(MS_Table_norm, 1, function(row) {
  sapply(1:50, function(i) {
    spalten_index = ((i - 1) * 3 + 1):(i * 3)
    mean(row[spalten_index])
  })
}))

# Creating two mean subtables for each treatment
Mittelwerte_Kontrolle = as.data.frame(Mittelwert_matrix[, seq(1, 50, by=2)])
Mittelwerte_RNAse = as.data.frame(Mittelwert_matrix[, seq(2, 50, by=2)])

# Naming sub-tables correctly
colnames(Mittelwerte_Kontrolle) <- paste0(Fraktionsnamen[seq(1, 50, by=2)])
colnames(Mittelwerte_RNAse) <- paste0(Fraktionsnamen[seq(1, 50, by=2)])
  
```

#Protein distribution of the two treatments for an example protein to get an overview of the differences
```{r}
zeile = 'ACOT9_HUMAN'

#Combine y-values for both treatments
alle_werte <- c(Mittelwerte_Kontrolle[zeile,], Mittelwerte_RNAse[zeile,])
ylim_bereich <- range(alle_werte, na.rm = TRUE)

#more place for the legend
par(mar = c(5, 4, 6, 2))

#First plot for control
plot(1:25, Mittelwerte_Kontrolle[zeile,], type = "l", col = 'purple',
     xlab = "fraction", ylab = "Intensity", main = "Protein distribution",
     ylim = ylim_bereich)

#Second plot for RNAse
lines(1:25, Mittelwerte_RNAse[zeile,], col = "darkblue")

#Create legend
legend("topright", inset = c(0, 0.02),  
       legend = c("Control", "RNAse"),
       col = c("purple", "darkblue"),
       lty = 1, cex = 0.6,              
       bty = "n") 
```

## Determining the maximum values

# Now we determine the maximum values using a function that we can then apply to all proteins. The threshold value is set to 2 and, in addition to the local and absolute maxima, plateaus and edge maxima are also taken into account.
```{r}
#Set up function and set threshold value to 2
find_maxima = function(mat, threshold = 2) {
  result = do.call(rbind, lapply(1:nrow(mat), function(i) {
    x = mat[i, ]
    
    # normal Maxima: look at the first numerical derivative, if there is a sign change it is a maximum
    idx = which(diff(sign(diff(x))) == -2) + 1 
    
    # Find plateau maxima: each plateau is checked for a local maximum, if the plateau value is greater than or equal to its direct neighbors, the average value of the plateau is calculated and saved
    rle_x = rle(x)  # Run-Length-Encoding 
    lengths = rle_x$lengths
    values = rle_x$values
    ends = cumsum(lengths)
    starts = ends - lengths + 1
    
    plateau_idx = c()
    for (j in seq_along(values)) {
      # only check Plateaus with lengths > 1 
      if (lengths[j] > 1) {
        start_pos = starts[j]
        end_pos = ends[j]
        
        # values right and left of the plateau
        left_val = if (start_pos > 1) x[start_pos - 1] else -Inf
        right_val = if (end_pos < length(x)) x[end_pos + 1] else -Inf
        
        # Plateau is a lokal Maximum, if itÂ´s value >= neighbor
        if (values[j] >= left_val && values[j] >= right_val) {
          plateau_idx = c(plateau_idx, round(mean(start_pos:end_pos)))
        }
      }
    }
    
    # Combine normal maxima and plateau maxima
    all_idx = sort(unique(c(idx, plateau_idx))) #unique: if values are duplicated they are removed, sort: sort the indices in ascending order
    
    # check edge maxima
    if (x[1] > x[2]) {all_idx = c(1, all_idx)}
    if (x[length(x)] > x[length(x)-1]) {all_idx = c(all_idx, length(x))}
    
    # only keep values > threshold = 2%
    all_idx = all_idx[x[all_idx] > threshold]
    
    # Clean up peaks: If two peaks have only one value between them, remove the smaller one
    if (length(all_idx) >= 2) {
      to_remove = c()
      for (k in 1:(length(all_idx)-1)) {
        if (all_idx[k+1] - all_idx[k] == 2) {
          # Indices of the peaks
          peak1 = all_idx[k]
          peak2 = all_idx[k+1]
          if (x[peak1] >= x[peak2]) {
            to_remove = c(to_remove, peak2)
          } else {
            to_remove = c(to_remove, peak1)
          }
        }
      } # remove the lower value
      if (length(to_remove) > 0) {
        all_idx = setdiff(all_idx, to_remove)
      }
    }
    
    if (length(all_idx) > 0) {
      data.frame(
        Protein = Proteinnamen[i],
        Zeile = i,
        Fraktion = all_idx,
        Wert = x[all_idx]
      )
    } else {
      NULL
    }
  }))
  
  rownames(result) = NULL
  return(result)
}

# Apply maxima function to our mean value tables for both treatments
Mittelwerte_Kontrolle_mat = as.matrix(sapply(Mittelwerte_Kontrolle, as.numeric))
Mittelwerte_RNAse_mat = as.matrix(sapply(Mittelwerte_RNAse, as.numeric))

Maxima_Mittelwerte_Kontrolle = find_maxima(Mittelwerte_Kontrolle_mat)
Maxima_Mittelwerte_RNAse = find_maxima(Mittelwerte_RNAse_mat)
```

## shoulder points

#Groups of adjacent fractions (at least 4 fractions next to each other) were sought that were not identified as maxima, but still showed a large amount of protein.
```{r}
# Create a function for finding the shoulder points
find_shoulders = function(binary_mat, Proteinnamen) {
  result = do.call(rbind, lapply(1:nrow(binary_mat), function(i) {
    x = binary_mat[i, ]
    rle_x = rle(x)
    lengths = rle_x$lengths
    values = rle_x$values
    ends = cumsum(lengths)
    starts = ends - lengths + 1
    
    schulter_idx = c()
    for (j in seq_along(values)) {
      if (values[j] == 1 && lengths[j] >= 4) {
        start_pos = starts[j]
        end_pos = ends[j]
        schulter_idx = c(schulter_idx, round(mean(start_pos:end_pos)))
      }
    }
    
    if (length(schulter_idx) > 0) {
      data.frame(
        Protein = Proteinnamen[i],
        Zeile = i,
        Fraktion = schulter_idx
      )
    } else {
      NULL
    }
  }))
  
  rownames(result) = NULL
  return(result)
}
```

### Find shoulder points for the mean value table for control

```{r}
#Temporary removal of protein quantity that is below threshold
Schulter_Mittelwerte_Kontrolle = ifelse(Mittelwerte_Kontrolle > 2, 1, 0) # if greater than 2 then it becomes 1 otherwise the value is set to 0

# Temporary removal of areas around maxima --> are set to 0: within a radius of 3
for (i in 1:nrow(Maxima_Mittelwerte_Kontrolle)) {
  Protein = Maxima_Mittelwerte_Kontrolle$Zeile[i]      # row (Protein)
  Fraktion = Maxima_Mittelwerte_Kontrolle$Fraktion[i]  # column (Fraction)
  
  # Calculate range limits for the columns (check limits!)
  #max(1, fraction-3) ensures that the start index is at least 1 (not <1)
  #min(ncol(...), fraction+3) ensures that the final index is at most the total number of columns (ncol(...))
  Fraktions_bereich = max(1, Fraktion - 3):min(ncol(Schulter_Mittelwerte_Kontrolle), Fraktion + 3)
  
  # Set the Â±3 columns to 0 only in this rows 
  Schulter_Mittelwerte_Kontrolle[Protein, Fraktions_bereich] = 0
}
#Apply function for shoulder points
Schulterpunkte_Kontrolle = find_shoulders(Schulter_Mittelwerte_Kontrolle, Proteinnamen)

```

### Find shoulder points for the mean value table for RNAse

```{r}
#Temporary removal of protein quantity that is below threshold
Schulter_Mittelwerte_RNAse = ifelse(Mittelwerte_RNAse > 2, 1, 0) # if greater than 2 then it becomes 1 otherwise the value is set to 0

# Temporary removal of areas around maxima --> are set to 0: within a radius of 3
for (i in 1:nrow(Maxima_Mittelwerte_RNAse)) {
  Protein = Maxima_Mittelwerte_RNAse$Zeile[i]      # row (Protein)
  Fraktion = Maxima_Mittelwerte_RNAse$Fraktion[i]  # column (Fraktion)
  
  #Calculate range limits for the columns (check limits!)
  #max(1, fraction-3) ensures that the start index is at least 1 (not <1)
  #min(ncol(...), fraction+3) ensures that the final index is at most the total number of columns (ncol(...))
  Fraktions_bereich = max(1, Fraktion - 3):min(ncol(Schulter_Mittelwerte_RNAse), Fraktion + 3)
  
  # Set the Â±3 columns to 0 only in this rows
  Schulter_Mittelwerte_RNAse[Protein, Fraktions_bereich] = 0
}
#Apply function for shoulder points
Schulterpunkte_RNAse = find_shoulders(Schulter_Mittelwerte_RNAse, Proteinnamen)
```


## Merging values

Ich wÃ¼rde das nochmal bisschen verÃ¤ndern aber so funktioniert es auf jeden Fall und wir haben Tabellen in denen jetzt alle Maxima & Schulterpunkte haben zum Weiterarbeiten

```{r}
# Add values for shoulder points
Schulterpunkte_Kontrolle$Fraktion_gerundet = round(Schulterpunkte_Kontrolle$Fraktion)
Schulterpunkte_Kontrolle$Wert = mapply(function(zeile, fraktion) {
  Mittelwerte_Kontrolle[zeile, fraktion]
}, Schulterpunkte_Kontrolle$Zeile, Schulterpunkte_Kontrolle$Fraktion_gerundet)

Schulterpunkte_RNAse$Fraktion_gerundet = round(Schulterpunkte_RNAse$Fraktion)
Schulterpunkte_RNAse$Wert = mapply(function(zeile, fraktion) {
  Mittelwerte_RNAse[zeile, fraktion]
}, Schulterpunkte_RNAse$Zeile, Schulterpunkte_RNAse$Fraktion_gerundet)


# Merging maxima values and shoulder points for controls
Maxima_Mittelwerte_Kontrolle$Typ = "Maxima"
Schulterpunkte_Kontrolle$Typ = "Schulter"

Combined_Kontrolle = rbind(
  Maxima_Mittelwerte_Kontrolle[, c("Protein", "Zeile", "Fraktion", "Wert", "Typ")],
  Schulterpunkte_Kontrolle[, c("Protein", "Zeile", "Fraktion", "Wert", "Typ")]
)
Combined_Kontrolle = Combined_Kontrolle[order(Combined_Kontrolle$Zeile, Combined_Kontrolle$Fraktion), ]

# Merging maxima values and shoulder points for RNAse
Maxima_Mittelwerte_RNAse$Typ = "Maxima"
Schulterpunkte_RNAse$Typ = "Schulter"

Combined_RNAse = rbind(
  Maxima_Mittelwerte_RNAse[, c("Protein", "Zeile", "Fraktion", "Wert", "Typ")],
  Schulterpunkte_RNAse[, c("Protein", "Zeile", "Fraktion", "Wert", "Typ")]
)
Combined_RNAse = Combined_RNAse[order(Combined_RNAse$Zeile, Combined_RNAse$Fraktion), ]
```


### P-values of the amplitude difference between control and RNAse maxima as the first criterion with which we later want to assign a shift category to the proteins

```{r}
# Rename column names of sub-tables to be able to access them via Combined_Kontrolle and Combined_RNAse
Ctrl1_frakt = Ctrl1_norm
colnames(Ctrl1_frakt) = c(1:25)
Ctrl2_frakt = Ctrl2_norm
colnames(Ctrl2_frakt) = c(1:25)
Ctrl3_frakt = Ctrl3_norm
colnames(Ctrl3_frakt) = c(1:25)

RNAse1_frakt = RNAse1_norm
colnames (RNAse1_frakt) = c(1:25)
RNAse2_frakt = RNAse2_norm
colnames(RNAse2_frakt) = c(1:25)
RNAse3_frakt = RNAse3_norm
colnames(RNAse3_frakt) = c(1:25)

# form Lists from the replicates of control and RNAse
ctrl_reps = list(Ctrl1_frakt, Ctrl2_frakt, Ctrl3_frakt)
rnase_reps = list(RNAse1_frakt, RNAse2_frakt, RNAse3_frakt)

# Dataframe of control and RNAse with only the positions of the peaks
peaks_ctrl = data.frame(Protein = Combined_Kontrolle$Protein, Fraktion = Combined_Kontrolle$Fraktion, Treatment = 'Kontrolle')
peaks_rnase = data.frame(Protein = Combined_RNAse$Protein, Fraktion = Combined_RNAse$Fraktion, Treatment = 'RNase')


# determine same fraction combinations of control and RNAse for the maxima
shared_peaks = merge(peaks_ctrl, peaks_rnase, by = c("Protein", "Fraktion"))

### Determine P values for the various maxima
# Set up dataframe for the results
p_Werte = data.frame()

for (i in 1:nrow(shared_peaks)) {
  protein  = shared_peaks$Protein[i]
  fraktion = as.character(shared_peaks$Fraktion[i])
  
  # Extract control values: via position in shared peaks
  ctrl_vals = sapply(ctrl_reps, function(df) {
    if (protein %in% rownames(df) && fraktion %in% colnames(df)) {
      return(df[protein, fraktion])
    } else {
      return(NA)
    }
  })

  # Extract RNAse values: via position in shared peaks
  rnase_vals = sapply(rnase_reps, function(df) {
    if (protein %in% rownames(df) && fraktion %in% colnames(df)) {
      return(df[protein, fraktion])
    } else {
      return(NA)
    }
  })
  
  # remove NA values
  ctrl_vals = na.omit(ctrl_vals)
  rnase_vals = na.omit(rnase_vals)

  # If necessary: Add mini fault with identical values, otherwise the variance = 0 and cannot be used for the t-test
  if (length(ctrl_vals) >= 2 && all(abs(ctrl_vals - ctrl_vals[1]) < 1e-10)) {
    ctrl_vals[2] <- ctrl_vals[2] + 1e-6
  }
  if (length(rnase_vals) >= 2 && all(abs(rnase_vals - rnase_vals[1]) < 1e-10)) {
    rnase_vals[2] <- rnase_vals[2] + 1e-6
  }

  #t-test only if both groups have at least 2 values
  # Assumption for the t-test that replicates are normally distributed in order to be able to perform the t-test at all
  if (length(ctrl_vals) >= 2 && length(rnase_vals) >= 2) {
    # Paired t-test 
    t_p = tryCatch(
      t.test(ctrl_vals, rnase_vals, paired = TRUE)$p.value, 
      error = function(e) NA
    )
  } else {
    t_p = NA
  }

  p_Werte = rbind(p_Werte, data.frame(Protein = protein, Fraktion = fraktion, P_Value = t_p))
}

# FDR-Correction: adjust all p-values in your overall dataset to control the false discovery rate.
p_Werte$adj_p = p.adjust(p_Werte$P_Value, method = "BH")

# All significant p-values - haben wir die Ã¼berhaupt irgendwo benutzt?
p_werte_005 = p_Werte$Protein[which(p_Werte$adj_p <= 0.05)]

```


## Create a function with criteria selected by us that are determined for each protein. These criteria will later predict which Shift_Category each protein will be assigned to.
#The following criteria are examined:

- Number of maximum values for RNAse and control respectively
- Distances of the maxima between control and RNAse
- Shift index: Sum of the distances between control and RNAse maxima
- Amount of protein under the peak curves
- Loss of amplitude between RNAse and Control
- Gain of amplitude between RNAse and Control
- Summed_loss = sum of the loss amplitude
- Summed_gain = sum of the gain amplitude
- P-values for amplitude intervals

```{r}
#extract only the columns â€œFractionâ€ and â€œValueâ€ and split this 2-column data based on the grouping variable Combined_Control$Protein.Result: a list in which each element corresponds to a protein ID.
liste_maxima_Ctrl = split(Combined_Kontrolle[, c("Fraktion", "Wert")], Combined_Kontrolle$Protein)
liste_maxima_RNAse = split(Combined_RNAse[, c("Fraktion", "Wert")], Combined_RNAse$Protein)

#For area calculation with trapezoidal rule
library(pracma)  

#define the function
hol_shifts <- function(protein, threshold_rel = 0.3) {
  window <- 2  # Size of the fraction window

  # get the maximum values of the current protein
  ctrl_maxima <- liste_maxima_Ctrl[[protein]]
  rnase_maxima <- liste_maxima_RNAse[[protein]]

  #If the protein is not present in one of the lists, the value is assigned the number zero
  if (is.null(ctrl_maxima)) ctrl_maxima <- data.frame(Fraktion = numeric(0), Wert = numeric(0))
  if (is.null(rnase_maxima)) rnase_maxima <- data.frame(Fraktion = numeric(0), Wert = numeric(0))
  
  #if a value exists, the maximum of the values of this protein is calculated. Then all fractions whose value is at least over threshold are filtered. These are considered as â€œmaximaâ€
  if (nrow(ctrl_maxima) > 0) {
    max_ctrl = max(ctrl_maxima$Wert)
    ctrl_maxima = ctrl_maxima[ctrl_maxima$Wert >= threshold_rel * max_ctrl, ]
  }
  
  if (nrow(rnase_maxima) > 0) {
    max_rnase = max(rnase_maxima$Wert)
    rnase_maxima = rnase_maxima[rnase_maxima$Wert >= threshold_rel * max_rnase, ]
  }

  #Counting the maxima found
  nb_ctrl_maxima <- nrow(ctrl_maxima)
  nb_rnase_maxima <- nrow(rnase_maxima)

  # Distances between the maxima
  abstÃ¤nde <- c()
  for (i in 1:nb_ctrl_maxima) {
    for (j in 1:nb_rnase_maxima) {
      abstand <- rnase_maxima$Fraktion[j] - ctrl_maxima$Fraktion[i]
      abstÃ¤nde <- c(abstÃ¤nde, abstand)
    }
  }

  # Function for area calculation with trapezoidal rule to obtain protein quantity
  calc_area <- function(df_list, protein, center_frac, window) {
    sapply(df_list, function(df) {
      if (protein %in% rownames(df)) {
        fracs <- as.numeric(colnames(df))
        idxs <- which(fracs >= (center_frac - window) & fracs <= (center_frac + window))
        if (length(idxs) >= 2) {
          x_vals <- fracs[idxs]
          y_vals <- as.numeric(df[protein, idxs])
          y_vals <- na.omit(y_vals)
          if (length(y_vals) == length(x_vals) && length(y_vals) >= 2) {
            return(trapz(x_vals, y_vals))
          }
        }
      }
      return(NA)
    })
  }

  # Amplitude loss and area under control peaks
  loss_list <- c()
  flaeche_kontrolle <- c()
  for (i in 1:nb_ctrl_maxima) {
    fraktion_i <- as.character(ctrl_maxima$Fraktion[i])
    amp_ctrl <- ctrl_maxima$Wert[i]

    amp_rnase <- Combined_RNAse$Wert[Combined_RNAse$Protein == protein & Combined_RNAse$Fraktion == fraktion_i]
    if (length(amp_rnase) == 0) amp_rnase <- 0

    loss_list <- c(loss_list, amp_ctrl - amp_rnase)

    flÃ¤chen_vals <- calc_area(ctrl_reps, protein, as.numeric(fraktion_i), window)
    flaeche_kontrolle <- c(flaeche_kontrolle, mean(na.omit(flÃ¤chen_vals)))
  }

  # Amplitude gain and area under RNAse peaks
  gain_list <- c()
  flaeche_rnase <- c()
  for (i in 1:nb_rnase_maxima) {
    fraktion_i <- as.character(rnase_maxima$Fraktion[i])
    amp_rnase <- rnase_maxima$Wert[i]

    amp_ctrl <- Combined_Kontrolle$Wert[Combined_Kontrolle$Protein == protein & Combined_Kontrolle$Fraktion == fraktion_i]
    if (length(amp_ctrl) == 0) amp_ctrl <- 0

    gain_list <- c(gain_list, amp_rnase - amp_ctrl)

    flÃ¤chen_vals <- calc_area(rnase_reps, protein, as.numeric(fraktion_i), window)
    flaeche_rnase <- c(flaeche_rnase, mean(na.omit(flÃ¤chen_vals)))
  }

  # p-values for peaks from previously calculated p_values
  p_values <- sapply(ctrl_maxima$Fraktion, function(f) {
    p_val <- p_Werte$adj_p[p_Werte$Protein == protein & p_Werte$Fraktion == f]
    if (length(p_val) == 0) NA else p_val[1]
  })

  return(list(
    Protein = protein,
    Anzahl_Kontroll_Maxima = nb_ctrl_maxima,
    Anzahl_RNase_Maxima = nb_rnase_maxima,
    AbstÃ¤nde_Maxima = abstÃ¤nde,
    Shift_idx = sum(abstÃ¤nde),
    Verlust_Amplituden = loss_list,
    Gewinn_Amplituden = gain_list,
    Summierter_Verlust = sum(loss_list),
    Summierter_Gewinn = sum(gain_list),
    FlÃ¤che_Kontrolle = flaeche_kontrolle,
    FlÃ¤che_RNase = flaeche_rnase,
    p_Werte = p_values
  ))
}

zeile = 'ACOT9_HUMAN'

hol_shifts(zeile)
```

#Create a dataframe with all these criteria for each protein
```{r}
proteine = unique(c(names(liste_maxima_Ctrl), names(liste_maxima_RNAse)))

ergebnisse = lapply(proteine, function(p) {
  res = hol_shifts(p)
  
  data.frame(
    Protein = res$Protein,
    Anzahl_Kontroll_Maxima = res$Anzahl_Kontroll_Maxima,
    Anzahl_RNase_Maxima = res$Anzahl_RNase_Maxima,
    Shift_idx = res$Shift_idx,
    Summierter_Verlust = res$Summierter_Verlust,
    Summierter_Gewinn = res$Summierter_Gewinn,
    Abstaende_Maxima = paste(res$AbstÃ¤nde_Maxima, collapse = ";"),
    Verlust_Amplituden = paste(res$Verlust_Amplituden, collapse = ";"),
    Gewinn_Amplituden = paste(res$Gewinn_Amplituden, collapse = ";"),
    FlÃ¤che_Kontrolle = paste(res$FlÃ¤che_Kontrolle,collapse = ";"),
    FlÃ¤che_RNase = paste(res$FlÃ¤che_RNase,collapse = ";"),
    p_Werte = paste(res$p_Werte, collapse = ";")
  )
})
df_ergebnisse = do.call(rbind, ergebnisse)

#Remove proteins
df_ergebnisse = df_ergebnisse[df_ergebnisse$Protein != 'P210L_HUMAN',]
df_ergebnisse = df_ergebnisse[df_ergebnisse$Protein != 'PKD1_HUMAN',]
df_ergebnisse = df_ergebnisse[df_ergebnisse$Protein != 'TGM7_HUMAN',]
df_ergebnisse = df_ergebnisse[df_ergebnisse$Protein != 'KIF1A_HUMAN',]


df_ergebnisse_test = df_ergebnisse
```


### Criteria function
 
## For each protein, we examined how many criteria it fulfilled and determined an individual shift score for each protein. Based on this score, the proteins can now be divided into the categories: "strong", "moderate" or "no"-shift. 

- score >= 5: "starker" shift
- score >= 4: "moderater" shift
- score < 4: "kein" shift

-   Kriterien die gegeben sein mÃ¼ssen:

-   p-Wert muss \< 0.05 sein damit signifikant (im Zusammenhang mit gain/loss)

-   Summe der horizontale Differenz der Maximastellen (x-Werte) RNAse - Kontrolle:

    -   =0: kein shift

    -   \<0: left shift

    -   \>0 right shift

wenn das gegeben ist dann 100% ein Shiftendes Protein = RNA-AbhÃ¤ngigkeiten

-   wenn Anzahl an Maxima sich verÃ¤ndert dann shift

- 

wenn horizontale Differnez = 0 aber (verÃ¤nderung der Anzahl an peaks):
-   gain/loss  !! nochmal genauer!!
- erst verlust dann Gewinn => right
- erst Gewinn dann Verlust => left



```{r}
#create a function for calculation of the score
klassifiziere_protein_shift_streng_v2 <- function(row) {
  parse_numeric_vector <- function(x) {
    if (is.na(x) || is.null(x) || x == "") return(numeric(0))
    suppressWarnings(as.numeric(unlist(strsplit(as.character(x), ";"))))
  }

  get_centroid <- function(x) {
    if (length(x) == 0 || all(is.na(x)) || all(x == 0)) return(NA_real_)
    weighted.mean(seq_along(x), x, na.rm = TRUE)
  }

  score <- 0
  richtung <- NA
  
  ### 1. category Shift_idx (max 2 points for score)
  shift_idx <- suppressWarnings(as.numeric(row[["Shift_idx"]]))
  if (!is.na(shift_idx)) {
    if (abs(shift_idx) >= 2) {
      score <- score + 2
      # Shift_idx > 0 --> right
      # Shift_idx < 0 --> left
      richtung <- ifelse(shift_idx > 0, "right", "left")
    } else if (abs(shift_idx) == 1) {
      score <- score + 1
      richtung <- ifelse(shift_idx > 0, "right", "left")
    }
  }
  
  ### 2) Difference in number of maximum between RNAse and control (max 2 points for score)
  max_kontrolle <- suppressWarnings(as.numeric(row[["Anzahl_Kontroll_Maxima"]]))
  max_rnase <- suppressWarnings(as.numeric(row[["Anzahl_RNase_Maxima"]]))
  if (!is.na(max_kontrolle) && !is.na(max_rnase)) {
    diff_maxima <- max_rnase - max_kontrolle
    abs_diff <- abs(diff_maxima)
    if (abs_diff >= 2) {
      score <- score + 2
      if (is.na(richtung)) richtung <- ifelse(diff_maxima > 0, "right", "left")
    } else if (abs_diff == 1) {
      score <- score + 1
      if (is.na(richtung)) richtung <- ifelse(diff_maxima > 0, "right", "left")
    }
  }

  ### 3) p-value (Significance gives plus points for the score)
  p_vals <- parse_numeric_vector(row[["p_Werte"]])
  p_vals_vorhanden <- length(p_vals) > 0 && !all(is.na(p_vals))
  signifikant <- p_vals_vorhanden && any(p_vals < 0.05, na.rm = TRUE)
  if (signifikant) {
    score <- score + 2
  } else if (!p_vals_vorhanden) {
    score <- score + 1
    if (is.na(richtung)) richtung <- "right" 
  }
  
  ### 4)  Difference in peak areas between RNAse and control 
  flaeche_k <- parse_numeric_vector(row[["FlÃ¤che_Kontrolle"]])
  flaeche_r <- parse_numeric_vector(row[["FlÃ¤che_RNase"]])
  delta_flaeche <- sum(flaeche_r, na.rm = TRUE) - sum(flaeche_k, na.rm = TRUE)
  if (!is.na(delta_flaeche)) {
    if (abs(delta_flaeche) > 30) {
      score <- score + 2
      if (is.na(richtung)) richtung <- ifelse(delta_flaeche > 0, "right", "left")
    } else if (abs(delta_flaeche) > 15) {
      score <- score + 1
      if (is.na(richtung)) richtung <- ifelse(delta_flaeche > 0, "right", "left")
    }
    # special case: shift_idx == 0 but big difference in Area difference under paek   --> Score + 1
    if (!is.na(shift_idx) && shift_idx == 0 && abs(delta_flaeche) > 30) {
      score <- score + 1
    }
    # Centroid comparison (center of peak areas) between RNAse and control
    zentroid_k <- get_centroid(flaeche_k)
    zentroid_r <- get_centroid(flaeche_r)
    if (!is.na(zentroid_k) && !is.na(zentroid_r)) {
      centroid_diff <- zentroid_r - zentroid_k
      if (abs(centroid_diff) >= 2) {
        score <- score + 1
        if (is.na(richtung)) richtung <- ifelse(centroid_diff > 0, "right", "left")
      }
    }
  }
  
  ### 5) Compare summed loss and gain of RNase and control amplitudes, but only if p-value of amplitude intervals is significant
  if (signifikant) {
    sum_gewinn <- suppressWarnings(as.numeric(row[["Summierter_Gewinn"]]))
    sum_verlust <- suppressWarnings(as.numeric(row[["Summierter_Verlust"]]))
    if (!is.na(sum_gewinn) && !is.na(sum_verlust)) {
      diff_sum <- sum_gewinn - sum_verlust
      if (abs(diff_sum) > 10) {
        score <- score + 1
      }
    }
  }
  
  ### 6) Compare the position of the amplitudes, but only if the p-value of the amplitude is significant. If amplitude remains the same then no point for score
  if (signifikant) {
    verlust_vec <- parse_numeric_vector(row[["Verlust_Amplituden"]])
    gewinn_vec <- parse_numeric_vector(row[["Gewinn_Amplituden"]])
    if (length(verlust_vec) > 0 && length(gewinn_vec) > 0) {
      v_idx <- which.max(verlust_vec)
      g_idx <- which.max(gewinn_vec)
      if (!is.na(v_idx) && !is.na(g_idx) && v_idx != g_idx) {
        if (is.na(richtung)) {
          richtung <- ifelse(g_idx > v_idx, "right", "left")
        }
        score <- score + 1
      }
    }
  }
  
  if (is.na(richtung)) richtung <- "unbekannt"
  
  ### define the scores
  if (score >= 5) {
    kategorie <- paste0("strong_", richtung, "_shift")
  } else if (score >= 4) {
    kategorie <- paste0("moderate_", richtung, "_shift")
  } else {
    kategorie <- "no_shift"
  }
  
  return(list(Score = score, category = kategorie))
}

# Apply and save the function across all proteins and their categories
ergebnisse_liste <- apply(df_ergebnisse, 1, klassifiziere_protein_shift_streng_v2)
#Add Shift_Score and Shift_Kategorie to df_ergebnisse
df_ergebnisse$Shift_Score <- sapply(ergebnisse_liste, function(x) x$Score)
df_ergebnisse$Shift_Category <- sapply(ergebnisse_liste, function(x) x$category)


```

# Visualization of the Protein distribution for our poster
```{r}
zeile <- 'ACOT9_HUMAN'

# Combine y-values for both treatments
alle_werte <- c(Ctrl1_norm[zeile,], RNAse1_norm[zeile,])
ylim_bereich <- range(alle_werte, na.rm = TRUE)

# to get more place at the top (z.B. 15% more)
ylim_bereich[2] <- ylim_bereich[2] * 1.15

# first plot for control
plot(1:25, Ctrl1_norm[zeile,], type = "n",
     xlab = "Fractions", ylab = "Intensity of Proteins", main = paste("Protein distribution:", zeile),
     ylim = ylim_bereich)

# stain area under the curve
polygon(c(1:25, 25:1),
        c(Mittelwerte_Kontrolle[zeile,], rep(0, 25)),
        col = adjustcolor("purple", alpha.f = 0.3), border = NA)
lines(1:25, Mittelwerte_Kontrolle[zeile,], col = "purple", lwd = 2)

polygon(c(1:25, 25:1),
        c(Mittelwerte_RNAse[zeile,], rep(0, 25)),
        col = adjustcolor("darkblue", alpha.f = 0.3), border = NA)
lines(1:25, Mittelwerte_RNAse[zeile,], col = "darkblue", lwd = 2)

legend("topright", legend = c("Control", "RNAse"),
       col = c("purple", "darkblue"), lwd = 2, cex = 0.6, inset = c(0, -0.05))  

# Find the index of the current protein in the tables
idx_ctrl <- which(abs_Maxima_Mittelwerte_Kontrolle[, 1] == zeile)
idx_rnase <- which(abs_Maxima_Mittelwerte_RNAse[, 1] == zeile)

# Get maxima for control from table
max_fraktion_ctrl <- as.numeric(as.character(abs_Maxima_Mittelwerte_Kontrolle[idx_ctrl, 3]))
max_wert_ctrl <- as.numeric(as.character(abs_Maxima_Mittelwerte_Kontrolle[idx_ctrl, 4]))

# Get maxima for RNAse from table
max_fraktion_rnase <- as.numeric(as.character(abs_Maxima_Mittelwerte_RNAse[idx_rnase, 3]))
max_wert_rnase <- as.numeric(as.character(abs_Maxima_Mittelwerte_RNAse[idx_rnase, 4]))

# Vertical arrows for the maxima
arrows(x0 = max_fraktion_ctrl, y0 = 0,
       x1 = max_fraktion_ctrl, y1 = max_wert_ctrl,
       col = "purple", lwd = 1.5, length = 0.1)

arrows(x0 = max_fraktion_rnase, y0 = 0,
       x1 = max_fraktion_rnase, y1 = max_wert_rnase,
       col = "darkblue", lwd = 1.5, length = 0.1)

# Labels on the Maxima
text(x = max_fraktion_ctrl, y = max_wert_ctrl + 0.10 * max_wert_ctrl,
     labels = "Amplitude", col = "purple", cex = 0.8)

text(x = max_fraktion_rnase, y = max_wert_rnase + 0.05 * max_wert_rnase,
     labels = "Amplitude", col = "darkblue", cex = 0.8)

# Shift distance arrow between the maxima 
arrow_y <- min(max_wert_ctrl, max_wert_rnase)

arrows(x0 = max_fraktion_ctrl, y0 = arrow_y,
       x1 = max_fraktion_rnase, y1 = arrow_y,
       col = "black", lwd = 1.6, angle = 15, length = 0.1, code = 3)  # code=3 = beide Enden

# Label fÃ¼r den Shift
text(x = mean(c(max_fraktion_ctrl, max_fraktion_rnase)),
     y = arrow_y + 0.05 * arrow_y,
     labels = "Shift Distance", col = "black", cex = 0.8)

```

#Diagramm in grÃ¶ÃŸer
```{r}
zeile <- 'ACOT9_HUMAN'

# Combine y-values for both treatments
alle_werte <- c(Ctrl1_norm[zeile,], RNAse1_norm[zeile,])
ylim_bereich <- range(alle_werte, na.rm = TRUE)

# to get more place at the top (e.g. 15% more)
ylim_bereich[2] <- ylim_bereich[2] * 1.15

# first plot for control
plot(1:25, Ctrl1_norm[zeile,], type = "n",
     xlab = "Fractions", ylab = "Intensity of Proteins", main = paste("Protein distribution:", zeile),
     ylim = ylim_bereich, cex.lab=1.4, cex.main=1.6, cex.axis=1.2)

# stain area under the curve
polygon(c(1:25, 25:1),
        c(Mittelwerte_Kontrolle[zeile,], rep(0, 25)),
        col = adjustcolor("purple", alpha.f = 0.3), border = NA)
lines(1:25, Mittelwerte_Kontrolle[zeile,], col = "purple", lwd = 2)

polygon(c(1:25, 25:1),
        c(Mittelwerte_RNAse[zeile,], rep(0, 25)),
        col = adjustcolor("darkblue", alpha.f = 0.3), border = NA)
lines(1:25, Mittelwerte_RNAse[zeile,], col = "darkblue", lwd = 2)

legend("topright", legend = c("Control", "RNAse"),
       col = c("purple", "darkblue"), lwd = 2, cex = 0.9, inset = c(0, 0.02), yjust = 0)  

# Find the index of the current protein in the tables
idx_ctrl <- which(abs_Maxima_Mittelwerte_Kontrolle[, 1] == zeile)
idx_rnase <- which(abs_Maxima_Mittelwerte_RNAse[, 1] == zeile)

# Get maxima for control from table
max_fraktion_ctrl <- as.numeric(as.character(abs_Maxima_Mittelwerte_Kontrolle[idx_ctrl, 3]))
max_wert_ctrl <- as.numeric(as.character(abs_Maxima_Mittelwerte_Kontrolle[idx_ctrl, 4]))

# Get maxima for RNAse from table
max_fraktion_rnase <- as.numeric(as.character(abs_Maxima_Mittelwerte_RNAse[idx_rnase, 3]))
max_wert_rnase <- as.numeric(as.character(abs_Maxima_Mittelwerte_RNAse[idx_rnase, 4]))

# Vertical arrows for the maxima
arrows(x0 = max_fraktion_ctrl, y0 = 0,
       x1 = max_fraktion_ctrl, y1 = max_wert_ctrl,
       col = "purple", lwd = 1.5, length = 0.1)

arrows(x0 = max_fraktion_rnase, y0 = 0,
       x1 = max_fraktion_rnase, y1 = max_wert_rnase,
       col = "darkblue", lwd = 1.5, length = 0.1)

# Labels on the maxima
text(x = max_fraktion_ctrl, y = max_wert_ctrl + 0.10 * max_wert_ctrl,
     labels = "Amplitude", col = "purple", cex = 1.2)

text(x = max_fraktion_rnase, y = max_wert_rnase + 0.05 * max_wert_rnase,
     labels = "Amplitude", col = "darkblue", cex = 1.2)

# Shift distance arrow between the maxima 
arrow_y <- min(max_wert_ctrl, max_wert_rnase)

arrows(x0 = max_fraktion_ctrl, y0 = arrow_y,
       x1 = max_fraktion_rnase, y1 = arrow_y,
       col = "black", lwd = 1.6, angle = 15, length = 0.1, code = 3)  # code=3 = both ends

# Label for the shift
text(x = mean(c(max_fraktion_ctrl, max_fraktion_rnase)),
     y = arrow_y + 0.05 * arrow_y,
     labels = "Shift Distance", col = "black", cex = 1.2)

```


#Bar plot: show total number of proteins of all shift categories and classify into RBP and non-RBP
```{r}
library(dplyr)
library(ggplot2)

# Assign RBP status
df_ergebnisse_phys <- df_ergebnisse_phys %>%
  mutate(RBP_Gruppe = ifelse(Shift_Category == "no_shift", "non-RBP", "RBP"))

# Calculate sums of proteins per RBP_Group + Shift_Category
df_summary <- df_ergebnisse_phys %>%
  group_by(RBP_Gruppe, Shift_Category) %>%
  summarise(n = n(), .groups = "drop") %>%
  mutate(
    # Category label with number for the legend
    Kategorie_mit_n = paste0(Shift_Category, " (", n, ")")
  )

ggplot(df_summary, aes(x = RBP_Gruppe, y = n, fill = Kategorie_mit_n)) +
  geom_col(position = "stack") +
  scale_fill_manual(
    values = setNames(
      c("#A786C2", "#8684C2", "#7396AD", "#728083", "#DBCEE6"), 
      df_summary$Kategorie_mit_n
    )
  ) +
  labs(
    title = "Total Amount of Proteins per Shift category",
    x = "Protein Type", y = "Total Amount of Proteins", fill = "Shift-Category"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    plot.title = element_text(size = 18, face = "bold"),
    axis.title = element_text(size = 16),
    axis.text = element_text(size = 14),
    legend.title = element_text(size = 14),
    legend.text = element_text(size = 13)
  )

```



#Scatter-plot of the absolute maxima positions for RNAse and control plotted against each other
```{r}
#Generate two sub-tables for absolute maxima for control and RNAse
library(dplyr)

abs_Maxima_Mittelwerte_Kontrolle <- Maxima_Mittelwerte_Kontrolle %>%
  group_by(Protein) %>%                   # Grouping by protein
  slice_max(order_by = Wert, n = 1) %>% # Keep line with maximum maxima
  ungroup()

abs_Maxima_Mittelwerte_RNAse <- Maxima_Mittelwerte_RNAse %>%
  group_by(Protein) %>%                   # Grouping by protein
  slice_max(order_by = Wert, n = 1) %>% # Keep line with maximum maxima
  ungroup()
```

```{r}
merged <- merge(
  abs_Maxima_Mittelwerte_Kontrolle[, c("Protein", "Fraktion")],
  abs_Maxima_Mittelwerte_RNAse[, c("Protein", "Fraktion")],
  by = "Protein",
  suffixes = c("_control", "_rnase")
)

# Calculation of the number of points above, on and below the line y = x
above_line <- sum(merged$Fraktion_control > merged$Fraktion_rnase)
on_line <- sum(merged$Fraktion_control == merged$Fraktion_rnase)
below_line <- sum(merged$Fraktion_control < merged$Fraktion_rnase)

# Output of the values in the console
cat("Anzahl Proteine Ã¼ber der Linie:", above_line, "\n")
cat("Anzahl Proteine auf der Linie:", on_line, "\n")
cat("Anzahl Proteine unter der Linie:", below_line, "\n")

plot(
  y = merged$Fraktion_control,
  x = merged$Fraktion_rnase,
  xlim = c(0, 25),
  ylim = c(0, 25),
  ylab = "Peaks in the control gradient",
  xlab = "Peaks in the RNase gradient",
  pch = 16, col = rgb(0,0,0,0.5),
  main = "Distribution of the maximum values in the fractions"
)
abline(0, 1, col = "blue", lty = 2)

# Add text with the numbers at the bottom left
text(x = 19, y = 2,
     labels = paste0(
       "left_Shift: ", above_line, "\n",
       "no_Shift: ", on_line, "\n",
       "right_Shift: ", below_line),
     adj = 0, cex = 0.8, col = "black")

```

#Distribution of the Shift Scores
```{r}
hist(df_ergebnisse$Shift_Score,
     breaks = 30,
     col = "skyblue",
     main = "Distribution of the Shift Scores",
     xlab = "Shift Score")
```



# App fÃ¼r die Manuelle Bestimmung

```{#r}
library(shiny)

# ðŸ“¥ Daten laden
if (file.exists("df_ergebnisse_mit_bewertung.RData")) {
  load("df_ergebnisse_mit_bewertung.RData")
} else if (file.exists("df_ergebnisse_original.RData")) {
  load("df_ergebnisse_original.RData")
} else {
  stop("âŒ Keine Daten gefunden: Bitte stelle sicher, dass df_ergebnisse vorhanden ist.")
}

# Spalten fÃ¼r Bewertung & Anmerkung hinzufÃ¼gen, falls noch nicht vorhanden
if (!"Manuelle_Bewertung" %in% colnames(df_ergebnisse)) {
  df_ergebnisse$Manuelle_Bewertung <- NA_character_
}
if (!"Anmerkung" %in% colnames(df_ergebnisse)) {
  df_ergebnisse$Anmerkung <- NA_character_
}

# ðŸŸ¡ Start bei erstem unbewertetem Protein
start_index <- which(is.na(df_ergebnisse$Manuelle_Bewertung))[1]
if (is.na(start_index)) start_index <- 1

ui <- fluidPage(
  titlePanel("ðŸ”¬ Manuelle Protein-Bewertung"),
  sidebarLayout(
    sidebarPanel(
      textInput("start_protein_input", "Protein (Name):", value = df_ergebnisse$Protein[start_index]),
      actionButton("go_start", "Suchen"),
      br(), br(),
      actionButton("btn_prev", "â† Vorheriges Protein"),
      actionButton("btn_next", "NÃ¤chstes Protein â†’"),
      br(), br(),
      strong(textOutput("protein_position")),  # Anzeige "Protein X von Y"
      strong("Aktuelles Protein:"),
      textOutput("protein_name"),
      br(),
      radioButtons("bewertung", "Kategorie auswÃ¤hlen:",
                   choices = c("kein_shift", "moderater_right_shift", "starker_right_shift",
                               "moderater_left_shift", "starker_left_shift"),
                   selected = character(0)),
      textAreaInput("anmerkung", "Anmerkung (optional):", "", rows = 3),
      actionButton("save", "ðŸ’¾ Bewertung speichern"),
      br(), br(),
      strong("Automatische Kategorie:"),
      textOutput("auto_kat"),
      br(),
      actionButton("exit", "âŒ App beenden", class = "btn-danger"),
      br(),
      textOutput("save_status")
    ),
    mainPanel(
      plotOutput("plot", height = "400px")
    )
  )
)

server <- function(input, output, session) {
  current <- reactiveVal(start_index)
  save_status <- reactiveVal("")

  # Springe zum Protein, wenn "go_start" gedrÃ¼ckt wird
  observeEvent(input$go_start, {
    protein_name <- input$start_protein_input
    idx <- which(df_ergebnisse$Protein == protein_name)
    if (length(idx) == 1) {
      current(idx)
      save_status("")
    } else {
      showModal(modalDialog(
        title = "âš ï¸ Protein nicht gefunden",
        paste0("Protein '", protein_name, "' nicht gefunden. Bitte genau so eingeben wie in der Tabelle."),
        easyClose = TRUE
      ))
    }
  })

  # Eingabefelder aktualisieren, wenn sich aktuelles Protein Ã¤ndert
  observeEvent(current(), {
    idx <- current()
    updateRadioButtons(session, "bewertung",
                       selected = df_ergebnisse$Manuelle_Bewertung[idx])
    updateTextAreaInput(session, "anmerkung",
                        value = df_ergebnisse$Anmerkung[idx])
    updateTextInput(session, "start_protein_input",
                    value = df_ergebnisse$Protein[idx])
    save_status("")
  })

  observeEvent(input$btn_prev, {
    idx <- current()
    if (idx > 1) current(idx - 1)
  })

  observeEvent(input$btn_next, {
    idx <- current()
    if (idx < nrow(df_ergebnisse)) current(idx + 1)
  })

  output$protein_position <- renderText({
    paste0("Protein ", current(), " von ", nrow(df_ergebnisse))
  })

  output$protein_name <- renderText({
    df_ergebnisse$Protein[current()]
  })

  output$auto_kat <- renderText({
    df_ergebnisse$Shift_Kategorie[current()]
  })

  output$plot <- renderPlot({
    protein_id <- df_ergebnisse$Protein[current()]
    ctrl_vals <- as.numeric(Ctrl1_norm[protein_id, ])
    rnase_vals <- as.numeric(RNAse1_norm[protein_id, ])
    y_range <- range(c(ctrl_vals, rnase_vals), na.rm = TRUE)

    plot(1:length(ctrl_vals), ctrl_vals, type = "l", col = "purple", ylim = y_range,
         xlab = "Fraktion", ylab = "IntensitÃ¤t", main = protein_id)
    lines(1:length(rnase_vals), rnase_vals, col = "darkblue")
    legend("topright", legend = c("Kontrolle", "RNase"), col = c("purple", "darkblue"), lty = 1)
  })

  observeEvent(input$save, {
    idx <- current()
    df_ergebnisse$Manuelle_Bewertung[idx] <<- input$bewertung
    df_ergebnisse$Anmerkung[idx] <<- input$anmerkung
    save(df_ergebnisse, file = "df_ergebnisse_mit_bewertung.RData")
    save_status("ðŸ’¾ Bewertung gespeichert!")
    if (idx < nrow(df_ergebnisse)) {
      current(idx + 1)
    } else {
      showModal(modalDialog("ðŸŽ‰ Letztes Protein erreicht!", easyClose = TRUE))
    }
  })

  # Speichern beim SchlieÃŸen der Session (z.B. Browser schlieÃŸen)
  session$onSessionEnded(function() {
    save(df_ergebnisse, file = "df_ergebnisse_mit_bewertung.RData")
  })

  observeEvent(input$exit, {
    save(df_ergebnisse, file = "df_ergebnisse_mit_bewertung.RData")
    stopApp()
  })

  output$save_status <- renderText({
    save_status()
  })
}

shinyApp(ui, server)

```

